map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
} 

map $http_x_scope_orgid $ensured_x_scope_orgid {
  default $http_x_scope_orgid;
  "" "anonymous";
}

upstream labs {
    server labs:3000;
}

upstream grafana {
    server grafana:3000;
}

upstream dcim {
    server dcim:8080;
}

upstream keycloak {
    server keycloak:80;
}

upstream api {
    server api:4000;
}

upstream websocket {
    server api:4000;
}

upstream mimir {
  server mimir:80;
}

upstream ws-test {
  server 192.168.2.21:4000;
}

server {
  server_name labs.devops.multpex.com.br;
  root /var/www;
  index index.html;

  access_log /var/log/nginx/access-labs.devops.multpex.com.br.log main;
  error_log  /var/log/nginx/error-labs.devops.multpex.com.br.log;

  #include common.conf;
  #include gzip.conf;
  #include cache.conf;
  #include block-injection.conf;

  location /socket.io/ {
    proxy_pass http://ws-test;
    proxy_set_header Host  $host;
    proxy_read_timeout     60;
    proxy_connect_timeout  60;
    proxy_redirect         off;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }

  # mimir / prometheus
  location = /labs/tapestry/push  {
    auth_request /_backend/serverauth;
    auth_request_set $auth_status $upstream_status;
    auth_request_set $x_scope_orgid $upstream_http_x_scope_orgid;
    auth_request_set $x_scope_ipaddr $upstream_http_x_scope_ipaddr;
    auth_request_set $x_scope_hostname $upstream_http_x_scope_hostname;

    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Host   $host;
    proxy_set_header    X-Forwarded-Server $host;
    proxy_set_header    X-Forwarded-Port   $server_port;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_set_header    X-Scope-OrgID      $x_scope_orgid;
    proxy_set_header    X-Original-URI     "http://mimir/api/v1/push";

    #proxy_pass http://127.0.0.1:3001/debug;
    proxy_pass http://mimir/api/v1/push;
  }

  # KEYCLOAK
  location /apps/auth/ {
    allow all;
    proxy_next_upstream off;

    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Host   $host;
    proxy_set_header    X-Forwarded-Server $host;
    proxy_set_header    X-Forwarded-Port   $server_port;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_hide_header   X-Frame-Options;

    proxy_busy_buffers_size 512k;
    proxy_buffers   4 512k;
    proxy_buffer_size   256k;
    proxy_http_version 1.1;
    proxy_pass http://keycloak$request_uri;
  }

  # GRAFANA
  location /apps/grafana/ {
    allow all;
    proxy_next_upstream off;

    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Host   $host;
    proxy_set_header    X-Forwarded-Server $host;
    proxy_set_header    X-Forwarded-Port   $server_port;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_hide_header   X-Frame-Options;

    proxy_busy_buffers_size 512k;
    proxy_buffers   4 512k;
    proxy_buffer_size   256k;
    proxy_http_version 1.1;
    proxy_pass http://grafana$request_uri;
  }

  location /apps/grafana/api/live/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $http_host;
    proxy_pass http://grafana;
  }

  # DCIM
  #location /apps/dcim/login/ {
  #  allow all;
  #  rewrite ^/apps/dcim/login/(.*)$ /apps/dcim/saml2 redirect;
  #} 

  location /apps/dcim/ {
    allow all;
    proxy_next_upstream off;

    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Host   $host;
    proxy_set_header    X-Forwarded-Server $host;
    proxy_set_header    X-Forwarded-Port   $server_port;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_hide_header   X-Frame-Options;

    proxy_busy_buffers_size 512k;
    proxy_buffers   4 512k;
    proxy_buffer_size   256k;
    proxy_http_version 1.1;
    proxy_pass http://dcim$request_uri;
  }

  # LABS HOME
  location / {
    allow all;
    proxy_next_upstream off;

    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Host   $host;
    proxy_set_header    X-Forwarded-Server $host;
    proxy_set_header    X-Forwarded-Port   $server_port;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_hide_header   X-Frame-Options;

    proxy_busy_buffers_size   512k;
    proxy_buffers   4 512k;
    proxy_buffer_size   256k;
    proxy_http_version 1.1;
    proxy_pass http://labs$request_uri;
  }

  listen [::]:443 ssl ipv6only=on; # managed by Certbot
  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/labs.devops.multpex.com.br/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/labs.devops.multpex.com.br/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
  if ($host = labs.devops.multpex.com.br) {
    return 301 https://$host$request_uri;
  } # managed by Certbot

  server_name labs.devops.multpex.com.br;
  listen 80;
  return 404; # managed by Certbot
}
